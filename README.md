# Асинхронный клиент Wildberries API

Этот проект представляет собой асинхронный клиент для работы с API Wildberries, который позволяет выполнять поиск товаров, получать детальную информацию о них, находить похожие товары и загружать изображения.

## Основные возможности

- Асинхронный поиск товаров по запросу
- Получение детальной информации о товарах
- Поиск похожих товаров
- Загрузка изображений товаров
- Кеширование результатов для повышения производительности
- Механизм повторных попыток для обработки временных сбоев API
- Обработка различных типов ответов API (JSON, текст)

## Структура проекта

- `wildberries_async.py` - Основной класс для работы с API Wildberries
- `test_wildberries_async.py` - Тестовый скрипт для проверки функциональности
- `photo/` - Директория для сохранения загруженных изображений

## Использование

### Поиск товаров

```python
import asyncio
from wildberries_async import WildberriesAsyncAPI

async def main():
    api = WildberriesAsyncAPI(cache_enabled=True)
    
    try:
        # Поиск товаров по запросу
        products = await api.search_products_async("платье", limit=5)
        
        # Вывод информации о найденных товарах
        for product in products:
            print(f"Название: {product['name']}")
            print(f"Цена: {product['price']} руб.")
            print(f"URL: {product['url']}")
            print("---")
    
    finally:
        # Закрытие сессии
        await api.close()

if __name__ == "__main__":
    asyncio.run(main())
```

### Получение похожих товаров

```python
# Получение похожих товаров для товара с указанным ID
similar_products = await api.get_similar_products_async(product_id=12345678, limit=5)
```

### Загрузка изображений

```python
# Загрузка изображений для товара
image_paths = await api.download_product_images_async(product, max_images=3)
```

## Внесенные улучшения

1. **Обработка ошибок API**:
   - Добавлена обработка различных типов контента в ответах API (text/plain, application/json)
   - Реализована конвертация текстовых ответов в JSON
   - Добавлена проверка структуры ответа

2. **Улучшение стабильности**:
   - Добавлен механизм повторных попыток с экспоненциальной задержкой
   - Реализована обработка таймаутов при загрузке изображений
   - Добавлены заголовки для имитации браузера

3. **Обработка специфических случаев**:
   - Добавлена обработка поля "pics" как числа (вместо списка)
   - Реализована обработка недоступности сервиса похожих товаров

4. **Улучшение логирования**:
   - Добавлено подробное логирование всех операций
   - Логирование ошибок с трассировкой стека
   - Логирование типа контента и статуса ответа

## Запуск тестов

```bash
python test_wildberries_async.py --query "платье" --limit 5 --timeout 30
```

Параметры:
- `--query` - Поисковый запрос
- `--limit` - Максимальное количество результатов
- `--timeout` - Таймаут операций в секундах
- `--no-cache` - Отключение кеширования

## Требования

- Python 3.7+
- aiohttp
- asyncio
- logging

## Примечания

- API Wildberries может изменяться, что может потребовать обновления кода
- Некоторые эндпоинты могут быть недоступны (например, сервис похожих товаров)
- Загрузка изображений может занимать длительное время или завершаться с ошибкой из-за ограничений на стороне сервера